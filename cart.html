{% extends "base.html" %}

{% block title %}Cart - Restaurant{% endblock %}

{% block content %}
<div class="container">
    <h1 class="page-title">Shopping Cart</h1>
    <div id="cartContainer">
        <div class="cart-loading">Loading cart...</div>
    </div>
    <div class="cart-actions">
        <button class="btn btn-secondary" onclick="clearCart()">Clear Cart</button>
        <button class="btn btn-primary" onclick="window.location.href='/checkout'">Proceed to Checkout</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/cart.js') }}"></script>
<script>
    function loadCart() {
        fetch('/cart')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('cartContainer');
                if (data.items.length === 0) {
                    container.innerHTML = '<div class="empty-cart"><p>Your cart is empty</p><a href="/" class="btn btn-primary">Browse Menu</a></div>';
                    return;
                }
                
                let html = '<div class="cart-items">';
                data.items.forEach(item => {
                    html += `
                        <div class="cart-item">
                            <div class="cart-item-image">
                                <img src="${item.image || 'https://via.placeholder.com/100'}" alt="${item.name}" onerror="this.src='https://via.placeholder.com/100'">
                            </div>
                            <div class="cart-item-details">
                                <h3>${item.name}</h3>
                                <p>₹${item.price} each</p>
                            </div>
                            <div class="cart-item-quantity">
                                <button onclick="updateQuantity(${item.id}, ${item.quantity - 1})">-</button>
                                <span>${item.quantity}</span>
                                <button onclick="updateQuantity(${item.id}, ${item.quantity + 1})">+</button>
                            </div>
                            <div class="cart-item-total">
                                <p>₹${item.total}</p>
                                <button class="btn-remove" onclick="removeItem(${item.id})">Remove</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                html += `<div class="cart-summary"><h2>Total: ₹${data.total}</h2></div>`;
                container.innerHTML = html;
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('cartContainer').innerHTML = '<p>Error loading cart</p>';
            });
    }
    
    function updateQuantity(menuId, quantity) {
        if (quantity < 1) {
            removeItem(menuId);
            return;
        }
        fetch(`/update_cart/${menuId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ quantity: quantity })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadCart();
            }
        });
    }
    
    function removeItem(menuId) {
        fetch(`/remove_from_cart/${menuId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadCart();
            }
        });
    }
    
    function clearCart() {
        if (confirm('Are you sure you want to clear the cart?')) {
            fetch('/clear_cart', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadCart();
                }
            });
        }
    }
    
    loadCart();
</script>
{% endblock %}
